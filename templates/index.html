<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Painel Leads Lite | Modelo Estrela V14</title>

  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css', v=asset_version) }}">
</head>

<body>
  <div class="release-banner">Versão ativa no servidor: {{ ui_version }}</div>

  <header class="topbar">
    <div class="brand">
      <div class="logo">PL</div>
      <div>
        <div class="title">Painel Leads Lite</div>
        <div class="subtitle">Gestão Consolidada • BigQuery V14</div>
      </div>
    </div>

    <div class="actions">
      <button id="btnReload" class="btn">Recarregar Dados</button>
      <a id="btnExport" class="btn btn-ghost" href="/api/export?max_rows=50000" download>Exportar CSV</a>
    </div>
  </header>

  <main class="container">

    <section class="kpis">
      <div class="kpi">
        <div class="kpi-label">Total de Leads</div>
        <div class="kpi-value" id="kpiCount">—</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Status Predominante</div>
        <div class="kpi-value" id="kpiTopStatus">—</div>
      </div>
      <div class="kpi">
        <div class="kpi-label">Base de Dados</div>
        <div class="kpi-value kpi-value-small">BigQuery Pro</div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Importar Planilha Oficial</h2>
        <p>O arquivo será processado pela <strong>Procedure V14</strong> e distribuído para as dimensões.</p>
      </div>

      <div class="filters filters-6">
        <div class="field col-4">
          <label>Arquivo (CSV ou XLSX)</label>
          <input id="uploadFile" type="file" accept=".csv,.xlsx,.xls" />
        </div>

        <div class="field col-2">
          <label>Tag de Lote (Opcional)</label>
          <input id="uploadSource" placeholder="Ex: Lote_Fevereiro" />
          <small class="muted">Obs.: a API V14 ignora a tag por enquanto (guardado para futuras versões).</small>
        </div>

        <div class="field field-actions col-6">
          <button id="btnUpload" class="btn btn-primary">Processar no BigQuery</button>
          <span id="uploadStatus" class="muted"></span>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Filtros Dinâmicos</h2>
        <p>Busca em tempo real nas tabelas de dimensão. Agora com seleção múltipla em dropdown com checkbox.</p>
        <div class="novo-filtro-alerta">Novo filtro ativo: Modalidade</div>
      </div>

      <div class="filters filters-6">
        <div class="field col-2">
          <label>Status (Multi)</label>
          <!-- MULTI com checkbox -->
          <select id="fStatus" multiple placeholder="Todos os status..."></select>
        </div>

        <div class="field col-2">
          <label>Cursos (Multi)</label>
          <!-- MULTI com checkbox -->
          <select id="fCurso" multiple placeholder="Todos os cursos..."></select>
        </div>

        <div class="field col-2">
          <label>Modalidade (Multi)</label>
          <!-- MULTI com checkbox -->
          <select id="fModalidade" multiple placeholder="Todas as modalidades..."></select>
        </div>

        <div class="field col-2">
          <label>Polos (Multi)</label>
          <!-- MULTI com checkbox -->
          <select id="fPolo" multiple placeholder="Todos os polos..."></select>
        </div>

        <div class="field col-2">
          <label>Consultor (Multi)</label>
          <!-- MULTI com checkbox -->
          <select id="fConsultor" multiple placeholder="Todos os consultores..."></select>
        </div>

        <div class="field col-1">
          <label>Data Inicial</label>
          <input id="fIni" type="date" />
        </div>

        <div class="field col-1">
          <label>Data Final</label>
          <input id="fFim" type="date" />
        </div>

        <div class="field col-1">
          <label>Limite</label>
          <input id="fLimit" type="number" min="50" step="50" value="500" />
        </div>

        <div class="field field-actions col-2">
          <button id="btnApply" class="btn btn-primary">Aplicar Filtros</button>
          <button id="btnClear" class="btn btn-ghost">Limpar Tudo</button>
        </div>

        <div class="field col-3">
          <label>Busca rápida (Nome / CPF / Celular / Email)</label>
          <input id="fBusca" placeholder="Ex.: Maria / 12345678900 / 11999999999 / email@..." />
          <small class="muted">A lógica de busca (nome/cpf/celular/email) será aplicada no JS enviando os params corretos.</small>
        </div>
      </div>

      <!-- Dica visual simples: o TomSelect com plugin de checkbox usa o próprio dropdown -->
      <div class="muted section-hint">
        Dica: use o campo de busca dentro do dropdown para achar opções rápido e marque/desmarque as caixas.
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Leads Consolidados</h2>
        <p id="statusLine">Aguardando consulta...</p>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Data Inscrição</th>
              <th>Candidato</th>
              <th>CPF</th>
              <th>Celular</th>
              <th>Origem</th>
              <th>Polo</th>
              <th>Curso</th>
              <th>Status</th>
              <th>Consultor</th>
              <th>Campanha</th>
            </tr>
          </thead>
          <tbody>
            <!-- preenchido via JS -->
          </tbody>
        </table>
      </div>

      <div class="muted section-total">
        <span>Total retornado: </span><strong id="lblTotal">—</strong>
      </div>
    </section>

    <footer class="footer">
      <span>© Painel Leads Lite - Engenharia de Dados</span>
      <span class="muted">Infra: BigQuery + Modelo Estrela (Star Schema)</span>
      <span class="build-tag">UI {{ ui_version }}</span>
    </footer>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

  <!-- Plugin de checkbox para Tom Select (padrão do TomSelect via plugins) -->
  <script>
    // Apenas um "guard" pra evitar erro se algum bundle externo mudar.
    // O comportamento de checkbox em multi select vem via plugin 'checkbox_options'.
    // A inicialização completa ficará no static/js/app.js.
    window.__TOMSELECT_PLUGINS__ = {
      checkbox: "checkbox_options",
      remove_button: "remove_button",
      clear_button: "clear_button"
    };
  </script>

  <script src="{{ url_for('static', filename='js/app.js', v=asset_version) }}"></script>
</body>
</html>
